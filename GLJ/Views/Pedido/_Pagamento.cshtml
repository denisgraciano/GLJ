@model GLJ.Models.Pedido.PDPedido
@using MVC.Controls
@using MVC.Controls.Grid
<script src="@Url.Content("~/Scripts/jquery.selectboxes/jquery.selectboxes.js")" type="text/javascript"></script>
<div class="divTituloPagina">
    <h3>
        Informações de Pagamento</h3>
</div>
<div class="uniForm">
    <fieldset class="inlineLabels">
        <legend>Informações Pedido</legend>
        <p>
            @Html.LabelFor(m => m.TotalItens) @Html.TextBoxFor(m => m.TotalItens, new { id = "totalItens", @class = "noform", disabled = "disabled" })
        </p>
        <p>
            @Html.LabelFor(m => m.ValorTotal) @Html.TextBoxFor(m => m.ValorTotal, new { id = "valorTotal", alt = "decimal", @class = "noform", disabled = "disabled" })
        </p>
        <p>
            @Html.LabelFor(m => m.ValorRestantePagamento) @Html.TextBoxFor(m => m.ValorRestantePagamento, new { id = "totalRestante", alt = "decimal", @class = "noform", disabled = "disabled" })
        </p>
    </fieldset>
</div>
<div class="divTituloPagina">
    <h3>
        Pagamentos</h3>
</div>
<div class="uniForm">
    <fieldset class="inlineLabels">
        <div class="ctrlHolder">
            @Html.LabelFor(m => m.PagamentoPedido.TipoPagamento)
            @Html.DropDownListFor(m => m.PagamentoPedido.TipoPagamento, TempData["TiposPagamento"] as IEnumerable<SelectListItem>, "Selecione o Tipo de Pagamento", new { id = "cmbTipoPagamento" })
            <img src='@Url.Content("~/Content/img/info_tooltip.png")' title="@Html.Help(m => m.PagamentoPedido.TipoPagamento)" alt="" />
            <p class="formHint">
                @Html.ValidationMessageFor(m => m.PagamentoPedido.TipoPagamento)</p>
        </div>
    </fieldset>
</div>
<div id="divCartao" style="display: none">
    @Html.Partial("_PagamentoCartao", Model.PagamentoCartao)
</div>
<div id="divCheque" style="display: none">
    @Html.Partial("_PagamentoCheque", Model.PagamentoCheque)
</div>
<div id="divCash" style="display: none">
    @Html.Partial("_PagamentoDinhero", Model.PagamentoDinheiro)
</div>
<div id="divDebito" style="display: none">
    @Html.Partial("_PagamentoDebito", Model.PagamentoDebito)
</div>
<div class="line">
</div>
<div id="gridPagamento">
    @Html.Grid(new GridControl()
        .SetName("PagamentoPedidoGrid")
        .SetPageSize(20)
        .SetIsAutoSize(false)
        .SetListUrl(Url.Content("~/Pedido/Pagamentos/"))
        .SetHeight("'100%'")
        .UseColumns(GLJ.Models.Pedido.GridPedidoModel.BEPagamentoPedidoColumns)
        .UpdateDefaultPager(pager =>
            pager
                .ShowAdd(false)
                .ShowDel(true, deleteUrl: Url.Content("~/Pagamento/DeletarPagamento"))
                .ShowEdit(false)
                .ShowView(false)
                .ShowSearch(false, false)
                ))
</div>
<div class="line">
</div>
<div class="uniForm">
    <fieldset class="inlineLabels">
        <div class="buttonHolder">
            <input type="button" class="primaryAction" value="Continuar" onclick="finalizar();" />
            <div class="secondaryAction">
                @Html.ActionLink("Cancelar", "CancelarPedido", "Pedido")
            </div>
        </div>
    </fieldset>
</div>
<script language="javascript" type="text/javascript">
    $(document).ready(function () {
        $('#valorTotal').setMask();
        $('#totalRestante').setMask();

        $('#cmbTipoPagamento').change(function () {
            switch (this.value) {
                case "1": //Tipo Dinheiro
                    $('#divCash').show();
                    $('#divCartao').hide();
                    $('#divCheque').hide();
                    $('#divDebito').hide();
                    break;
                case "2": //Tipo Cheque
                    $('#divCheque').show();
                    $('#divCartao').hide();
                    $('#divCash').hide();
                    $('#divDebito').hide();
                    break;
                case "3": //Tipo Cartao
                    $('#divCartao').show();
                    $('#divCheque').hide();
                    $('#divCash').hide();
                    $('#divDebito').hide();
                    break;
                case "4": //Tipo Cartao de Débito
                    $('#divDebito').show();
                    $('#divCartao').hide();
                    $('#divCheque').hide();
                    $('#divCash').hide();
                    break;
                default:
                    $('#divCartao').hide();
                    $('#divCheque').hide();
                    $('#divCash').hide();
                    $('#divDebito').hide();
            }

        });
    });


    function PreencherDadosPagamento(data) {
        $('#cmbTipoPagamento').attr('disabled', '');

        $('#totalItens').val(data.TotalItens);
        $('#valorTotal').val(data.ValorTotal);
        $('#totalRestante').val(data.ValorRestantePagamento);

        if (data.ValorRestantePagamento <= 0) {
            $('#cmbTipoPagamento').attr('disabled', 'disabled');
        }

        $('#PagamentoPedidoGrid').jqGrid().trigger("reloadGrid");
    }

    function enumTipoPagamentoToString(cellvalue, options, rowObject) {
        var descricao = '';
        $.post(url + "/Pedido/CarregarTipoPagamento/", { enumValue: cellvalue }, function (ret) {
            descricao = ret.Descricao;
        });
        return descricao;
    }

    function finalizar() {
        if ($('#totalRestante').val() <= 0) {
            $.post('@Url.Action("SalvarAprovacao", "Pedido")', null, function (data) {
                if (data.Success) {
                    $('#tabs').tabs('enable', 2);
                    $('#tabs').tabs('select', 2);
                    

                    $('.success').html(data.Mensage);
                    $('.success').show();

                }
                else {
                    $('.error').html(data.Mensage);
                    $('.error').show();
                }
            });
        }
        else {
            $('.error').html('Informe o Pagamento.');
            $('.error').show();
        }
    }
</script>
