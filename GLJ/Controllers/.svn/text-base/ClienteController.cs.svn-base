using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using GLJ.Models.Cliente;
using GLJ.Models.BPFacade;
using GLJ.Filter.Entity;
using GLJ.Business.Entity;
using MVC.Controls;
using MVC.Controls.Grid;
using Onion.Business.Entity;

namespace GLJ.Controllers
{
    public class ClienteController : BaseControllerGeneric<PDCliente>
    {
        #region Métodos Chamada

        //[AuthorizeOnion]
        public ActionResult Index()
        {
            this.LimparMensagens();
            return View();
        }

        //[AuthorizeOnion]
        public ActionResult CadastroCliente(int? id)
        {
            if (id.HasValue && id.GetValueOrDefault() > 0)
            {
                this.ProcessData.Cliente = BPFCliente.Instance.ObterTodos(new FECliente() { Codigo = id.GetValueOrDefault(), CodigoLoja = UsuarioLogin.CodigoLoja }).ResultList.FirstOrDefault();
                this.ProcessData.DadosCliente.CodigoCliente = this.ProcessData.Cliente.Codigo;
                this.ProcessData.TelefoneCliente.CodigoCliente = this.ProcessData.Cliente.Codigo;
                Session["CodigoCliente"] = this.ProcessData.Cliente.Codigo;
            }
            else
            {
                Session["CodigoCliente"] = null;
            }
            this.CarregaCombos();
            CarregaUFCidade();
            return View(this.ProcessData);
        }

        //[AuthorizeOnion]
        public ActionResult ConsultarCliente()
        {
            CarregaUFCidade();
            return View(this.ProcessData);
        }

        #endregion

        #region Metodos Especificos
        [HttpPost]
        public ActionResult Salvar(PDCliente model)
        {
            try
            {
                if (Session["CodigoCliente"] != null)
                    model.Cliente.Codigo = (int)Session["CodigoCliente"];

                model.Cliente.CodigoLoja = UsuarioLogin.CodigoLoja;

                this.ProcessData.Cliente = new BPFCliente().Salvar(model.Cliente);
                base.AdicionarMensagemSucesso("Cliente Salvo Com sucesso!");
            }
            catch (Exception ex)
            {
                base.AdicionarMensagemErro(ex, ex.Message);
            }

            return RedirectToAction("CadastroCliente", new { id = this.ProcessData.Cliente.Codigo });
        }

        [HttpPost]
        public JsonResult AdicionarObservacao(PDCliente model)
        {
            try
            {
                model.Cliente.CodigoLoja = UsuarioLogin.CodigoLoja;
                model.Cliente.Codigo = (int)Session["CodigoCliente"];

                if (model.Cliente.Codigo > 0)
                {
                    string obs = model.Cliente.Observacao;
                    this.ProcessData.Cliente = BPFCliente.Instance.ObterTodos(new FECliente() { Codigo = model.Cliente.Codigo, CodigoLoja = model.Cliente.CodigoLoja }).ResultList.FirstOrDefault();
                    this.ProcessData.Cliente.Observacao = obs;
                    this.ProcessData.Cliente = new BPFCliente().Salvar(this.ProcessData.Cliente);
                }
                else
                {
                    throw new Exception("Salve os dados do cliente antes de adicionar uma obsevação.");
                }
                return Json(new JsonReturn(true, "Observação Salva Com sucesso!"));

            }
            catch (Exception ex)
            {
                return Json(new JsonReturn(true, ex.Message));

            }

        }

        [HttpPost]
        public JsonResult BuscarCliente(PDCliente model)
        {
            model.FECliente.CodigoLoja = UsuarioLogin.CodigoLoja;

            Session["FECliente"] = model.FECliente;
            return Json(null);
        }

        [HttpGet]
        public JsonResult Buscar(SearchModel searchModel)
        {
            Session["FECliente"] = Session["FECliente"] ?? new FECliente() { CodigoLoja = UsuarioLogin.CodigoLoja };
            List<BECliente> lst = BPFCliente.Instance.ObterTodos(Session["FECliente"] as FECliente).ResultList;

            GridData gridData = lst.AsQueryable().ToGridData(searchModel, GridClienteModel.BEClienteColumns);
            return Json(gridData, JsonRequestBehavior.AllowGet);

        }

        [HttpPost]
        public JsonResult BuscarClientePopUp(string Nome, string Cpf, string RG)
        {
            FECliente feCliente = new FECliente { CodigoLoja = UsuarioLogin.CodigoLoja, Nome = Nome, Cpf = Cpf, RG = RG };
            Session["FECliente"] = feCliente;
            return Json(null);
        }

        private void CarregaCombos()
        {
            var listTipo = Onion.Util.EnumHelper.GetDescriptions<TipoDadoCliente>();
            TempData["Tipos"] = new SelectList(listTipo, "Value", "Name");

            var listTipoTelefone = Onion.Util.EnumHelper.GetDescriptions<TipoTelefone>();
            TempData["TiposTelefone"] = new SelectList(listTipoTelefone, "Value", "Name");
        }

        [HttpGet]
        public JsonResult AutoCompleteCliente(string term)
        {
            FECliente feCliente = new FECliente 
            { 
                CodigoLoja = UsuarioLogin.CodigoLoja,
                Nome = term
            };
            
            var clientes = from c in BPFCliente.Instance.ObterTodos(feCliente).ResultList
                           select new
                           {
                               label = c.Nome,
                               value = c.Nome,
                               c.Codigo,
                               c.CPF,
                               c.Observacao
                           };

            
            return Json(clientes, JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public JsonResult ObterDetalheCliente(int? codigoCliente)
        {
            try
            {
                FEDadosCliente feDadosCliente = new FEDadosCliente
                {
                    CodigoCliente = codigoCliente.GetValueOrDefault(),
                };

                var DetalheCliente = from d in BPFDadosCliente.Instance.ObterTodos(feDadosCliente).ResultList
                                     select new
                                     {
                                         Endereco = d.Endereco + "," + d.Numero + " - " + d.Bairro + ", " + d.Cidade.NomeCidade,
                                         Nome = d.Cliente.Nome,
                                         CPF = d.Cliente.CPF
                                     };
                if (DetalheCliente.Count() > 0)
                {
                    return Json(new JsonReturn(true, "", DetalheCliente.FirstOrDefault()), JsonRequestBehavior.AllowGet);
                }
                else
                {
                    return Json(new JsonReturn(false,"Dados do cliente selecionado está incompleto."), JsonRequestBehavior.AllowGet);

                }
            }
            catch (Exception ex)
            {
                return Json(new JsonReturn(false,ex.Message), JsonRequestBehavior.AllowGet);
            }
          
        }
    
        [HttpGet]
        public JsonResult ObterDadosCliente(int? codigoCliente, SearchModel searchModel)
        {
            int cliente = (Session["CodigoCliente"] == null ? codigoCliente.GetValueOrDefault() : Convert.ToInt32(Session["CodigoCliente"].ToString()));
            FEDadosCliente feDadosCliente = new FEDadosCliente() { CodigoCliente = cliente };
            IQueryable<BEDadosCliente> model = new BPFCliente().ObterDadosCliente(feDadosCliente).AsQueryable();

            GridData gridData = model.ToGridData(searchModel, GridClienteModel.BEDadosClienteColumns);
            return Json(gridData, JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public JsonResult ObterTelefoneCliente(int? codigoCliente, SearchModel searchModel)
        {
            int cliente = (Session["CodigoCliente"] == null ? codigoCliente.GetValueOrDefault() : Convert.ToInt32(Session["CodigoCliente"].ToString()));
            FETelefoneCliente feTelefoneCliente = new FETelefoneCliente() { CodigoCliente = cliente };
            IQueryable<BETelefoneCliente> model = new BPFCliente().ObterTelefonesCliente(feTelefoneCliente).AsQueryable();

            GridData gridData = model.ToGridData(searchModel, GridClienteModel.BETelefoneCienteColumns);
            return Json(gridData, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult SalvarDados(PDCliente model)
        {
            try
            {
                model.DadosCliente.CodigoCliente = Convert.ToInt32(Session["CodigoCliente"].ToString());

                this.ProcessData.DadosCliente = new BPFCliente().SalvarDados(model.DadosCliente);
                return Json(new JsonReturn(true, "Endereço adicionado com sucesso!"));
            }
            catch (Exception ex)
            {
                return Json(new JsonReturn(false, ex.Message));
            }
        }

        [HttpPost]
        public ActionResult SalvarTelefone(PDCliente model)
        {
            try
            {
                model.TelefoneCliente.CodigoCliente = (int)Session["CodigoCliente"];
                this.ProcessData.TelefoneCliente = new BPFCliente().SalvarTelefone(model.TelefoneCliente);
                return Json(new JsonReturn(true, "Endereço adicionado com sucesso!"));
            }
            catch (Exception ex)
            {
                return Json(new JsonReturn(false, ex.Message));
            }
        }

        private void CarregaUFCidade()
        {
            if (!string.IsNullOrEmpty(this.ProcessData.DadosCliente.UF))
            {
                base.CarregaListaUF(this.ProcessData.DadosCliente.UF);

                base.CarregarCidade(this.ProcessData.DadosCliente.UF, this.ProcessData.DadosCliente.CodigoCidade);
            }
            else
            {
                base.CarregaListaUF();
            }
        }

        public ActionResult CarregarTipoEndereco()
        {
            System.Text.StringBuilder sb = new System.Text.StringBuilder();

            var listMotivo = Onion.Util.EnumHelper.GetDescriptions<TipoDadoCliente>();

            foreach (var m in listMotivo)
                sb.Append(m.Value.ToString() + ":" + m.Name + ";");

            return Json(sb.ToString(), JsonRequestBehavior.AllowGet);
        }

        public ActionResult CarregarTipoTelefone()
        {
            System.Text.StringBuilder sb = new System.Text.StringBuilder();

            var list = Onion.Util.EnumHelper.GetDescriptions<TipoTelefone>();

            foreach (var m in list)
                sb.Append(m.Value.ToString() + ":" + m.Name + ";");

            return Json(sb.ToString(), JsonRequestBehavior.AllowGet);
        }

        #endregion
    }
}
